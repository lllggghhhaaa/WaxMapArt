@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using WaxMapArt.Web.Services
@implements IDisposable
@rendermode InteractiveServer
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ImageService Image
@inject AuthService Auth
@inject UserProfileState UserProfileState

<header class="sticky top-0 inset-x-0 flex flex-wrap md:justify-start md:flex-nowrap z-50 w-full text-sm">
  <nav class="mt-4 relative max-w-5xl w-full bg-white border border-gray-200 rounded-[24px] mx-2 flex flex-wrap md:flex-nowrap items-center justify-between p-2 px-4 sm:mx-auto dark:bg-neutral-900 dark:border-neutral-700" aria-label="Global">
    
    <div id="navMenu" class="hs-collapse hidden md:!flex w-full md:w-auto flex-col md:flex-row md:items-center md:justify-start gap-1 md:gap-3 grow border-t border-gray-200 mt-2 pt-2 md:border-t-0 md:mt-0 md:pt-0 dark:border-neutral-700">
      <NavLink class="flex items-center gap-x-2 py-3 md:py-3 px-2 md:px-2 rounded-lg md:rounded-none border-s-2 md:border-s-0 md:border-b-2 border-transparent text-gray-500 hover:text-gray-800 hover:bg-gray-50 md:hover:bg-transparent dark:text-neutral-400 dark:hover:text-neutral-200 dark:hover:bg-neutral-800"
               ActiveClass="border-gray-800 text-gray-800 dark:border-neutral-200 dark:text-neutral-200"
               Match="NavLinkMatch.All"
               href="/">
        <i class="ri-home-2-line"></i>
        Home
      </NavLink>
      <NavLink class="flex items-center gap-x-2 py-3 md:py-3 px-2 md:px-2 rounded-lg md:rounded-none border-s-2 md:border-s-0 md:border-b-2 border-transparent text-gray-500 hover:text-gray-800 hover:bg-gray-50 md:hover:bg-transparent dark:text-neutral-400 dark:hover:text-neutral-200 dark:hover:bg-neutral-800"
               ActiveClass="border-gray-800 text-gray-800 dark:border-neutral-200 dark:text-neutral-200"
               Match="NavLinkMatch.Prefix"
               href="map">
        <i class="ri-artboard-2-line"></i>
        Map Generator
      </NavLink>
      <AuthorizeView>
        <Authorized>
          <NavLink class="flex items-center gap-x-2 py-3 md:py-3 px-2 md:px-2 rounded-lg md:rounded-none border-s-2 md:border-s-0 md:border-b-2 border-transparent text-gray-500 hover:text-gray-800 hover:bg-gray-50 md:hover:bg-transparent dark:text-neutral-400 dark:hover:text-neutral-200 dark:hover:bg-neutral-800"
                   ActiveClass="border-gray-800 text-gray-800 dark:border-neutral-200 dark:text-neutral-200"
                   Match="NavLinkMatch.Prefix"
                   href="palettes">
            <i class="ri-palette-line"></i>
            Palettes
          </NavLink>
        </Authorized>
      </AuthorizeView>
      <AuthorizeView Roles="Developer">
        <NavLink class="flex items-center gap-x-2 py-3 md:py-3 px-2 md:px-2 rounded-lg md:rounded-none border-s-2 md:border-s-0 md:border-b-2 border-transparent text-gray-500 hover:text-gray-800 hover:bg-gray-50 md:hover:bg-transparent dark:text-neutral-400 dark:hover:text-neutral-200 dark:hover:bg-neutral-800"
                 ActiveClass="border-gray-800 text-gray-800 dark:border-neutral-200 dark:text-neutral-200"
                 Match="NavLinkMatch.Prefix"
                 href="blocks">
          <i class="ri-box-2-fill"></i>
          Blocks
        </NavLink>
      </AuthorizeView>
    </div>

    <div class="flex items-center gap-2 w-full md:w-auto md:order-4 md:ms-4">
      <AuthorizeView>
        <Authorized>
          <a class="flex items-center gap-x-3" href="/profile">
            <div class="flex items-center gap-x-2">
              <img src="@_imageAvatarUrl" alt="User avatar" class="w-8 h-8 rounded-full border border-gray-300 dark:border-neutral-700 object-cover" />
              <span class="font-medium text-gray-800 dark:text-neutral-200">@_userName</span>
            </div>
            
            @if (_isDev)
            {
              <span class="inline-flex items-center rounded-full bg-pink-100 px-2 py-1 text-xs font-medium text-pink-800 ring-1 ring-inset ring-pink-600/20">
                <i class="ri-code-s-slash-line" />
              </span>
            }
          </a>
        </Authorized>
        <NotAuthorized>
          <div class="inline-flex items-center gap-x-3">
            <NavLink class="w-full sm:w-auto whitespace-nowrap py-2 px-4 inline-flex justify-center items-center gap-x-2 text-sm font-medium rounded-full border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 focus:outline-hidden focus:bg-gray-100 dark:bg-neutral-800 dark:text-neutral-200 dark:hover:bg-neutral-700" href="login">
              Log In
            </NavLink>
            <NavLink class="w-full sm:w-auto whitespace-nowrap py-2 px-4 inline-flex justify-center items-center gap-x-2 text-sm font-semibold rounded-full bg-gray-900 text-white hover:bg-gray-800 focus:outline-hidden focus:bg-gray-700 dark:bg-white dark:text-neutral-900 dark:hover:bg-neutral-200" href="signup">
              Sign Up
            </NavLink>
          </div>
        </NotAuthorized>
      </AuthorizeView>

      <div class="md:hidden ms-auto">
        <button type="button"
                class="hs-collapse-toggle flex justify-center items-center size-9.5 border border-gray-200 text-gray-500 rounded-full hover:bg-gray-200 focus:outline-hidden focus:bg-gray-200 dark:border-neutral-700 dark:text-neutral-400 dark:hover:bg-neutral-700 dark:focus:bg-neutral-700"
                aria-label="Change navigation"
                aria-controls="navMenu"
                data-hs-collapse="#navMenu">
          <svg class="hs-collapse-open:hidden shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
          <svg class="hs-collapse-open:block hidden shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>
  </nav>
</header>

@code {
    private string? _userName;
    private bool _isDev;
    private string _imageAvatarUrl = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();

        _userName = authState.User.Claims.FirstOrDefault(claim => claim.Type == ClaimTypes.Name)?.Value ?? "Guest";
        _isDev = authState.User.Claims.Any(claim => claim is { Type: ClaimTypes.Role, Value: "Developer" });

        var user = Auth.GetCurrentUser();
        _imageAvatarUrl = await Image.GetUserAvatarUrlAsync(user?.Id) ?? $"https://ui-avatars.com/api/?name={Uri.EscapeDataString(user?.Name ?? "User")}&background=random";
        UserProfileState.OnAvatarChanged += HandleAvatarChanged;
        
        StateHasChanged();
    }

    private void HandleAvatarChanged()
    {
        _imageAvatarUrl = UserProfileState.AvatarUrl ?? _imageAvatarUrl;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        UserProfileState.OnAvatarChanged -= HandleAvatarChanged;
    }
}