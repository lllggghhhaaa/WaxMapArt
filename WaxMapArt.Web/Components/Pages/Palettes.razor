@page "/palettes"
@attribute [Authorize]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using WaxMapArt.Web.Services
@using WaxMapArt.Web.Components.Components
@using WaxMapArt.Web.Entities
@inject AuthService Auth
@inject IDbContextFactory<DatabaseContext> DbContextFactory
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<div class="flex flex-col space-y-1">
    <div class="flex justify-end">
        <button @onclick="NavigateToAddPalette" type="button" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 focus:outline-hidden focus:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none">
            Add Palette
        </button>
    </div>
    <div class="-m-1.5 overflow-x-auto">
        <div class="p-1.5 min-w-full inline-block align-middle">
            <div class="border border-gray-200 rounded-lg overflow-hidden dark:border-neutral-700">
                <PrelineTable TItem="Palette"
                              Items="@_palettes"
                              TotalCount="@_totalCount"
                              IsLoading="@_isLoading"
                              CurrentPage="@_currentPage"
                              PageSize="@_pageSize"
                              InitialSortColumn="@nameof(Palette.Name)"
                              InitialSortAscending="true"
                              Columns="@_columns"
                              OnPageChanged="@LoadDataAsync"
                              ActionsTemplate="@ActionsTemplate"
                              LoadingText="Loading palettes..."
                              EmptyText="No palettes found.">
                </PrelineTable>
            </div>
        </div>
    </div>

</div>

@if (_openPopovers.Any())
{
    <div class="fixed inset-0 z-10" @onclick="CloseAllPopovers"></div>
    
    @foreach (var paletteId in _openPopovers.ToList())
    {
        <div class="fixed z-20 w-56" style="@_popoverPositions.GetValueOrDefault(paletteId, "top:0;left:0;")">
            <div class="divide-y divide-gray-100 rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none dark:bg-neutral-800 dark:divide-neutral-700 dark:ring-neutral-600">
                <div class="py-1">
                    <button @onclick="() => EditPalette(paletteId)" 
                            type="button"
                            class="group flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-neutral-300 dark:hover:bg-neutral-700 dark:hover:text-white">
                        <i class="ri-edit-2-line"></i>
                        <span class="ml-2">Edit</span>
                    </button>
                    <button @onclick="() => ConfirmDeletePalette(paletteId)" 
                            type="button"
                            class="group flex items-center w-full px-4 py-2 text-sm text-red-700 hover:bg-red-50 hover:text-red-900 dark:text-red-400 dark:hover:bg-red-900/20 dark:hover:text-red-300">
                        <i class="ri-delete-bin-2-line"></i>
                        <span class="ml-2">Delete</span>
                    </button>
                </div>
            </div>
        </div>
    }
}

@if (_showDeleteConfirm && _paletteToDelete != Guid.Empty)
{
    <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-neutral-800 dark:border-neutral-600">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/20">
                    <svg class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mt-4">Delete Palette</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500 dark:text-neutral-400">
                        Are you sure you want to delete this palette?
                    </p>
                </div>
                <div class="items-center px-4 py-3 space-x-2">
                    <button @onclick="CancelDelete" 
                            type="button"
                            class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 hover:bg-gray-600 dark:bg-neutral-600 dark:hover:bg-neutral-500">
                        Cancel
                    </button>
                    <button @onclick="() => DeletePalette(_paletteToDelete)" 
                            type="button"
                            class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-24 hover:bg-red-600 ml-2">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Palette> _palettes = [];
    private int _totalCount;
    private int _currentPage = 1;
    private int _pageSize = 25;
    private bool _isLoading = true;
    private Guid? _userId;
    
    private List<PrelineTable<Palette>.TableColumn<Palette>> _columns = [];
    
    private IJSObjectReference? _module;
    private readonly HashSet<Guid> _openPopovers = [];
    private bool _showDeleteConfirm;
    private Guid _paletteToDelete = Guid.Empty;
    private readonly Dictionary<Guid, ElementReference> _buttonRefs = new();
    private readonly Dictionary<Guid, string> _popoverPositions = new();
    private readonly Dictionary<Guid, ElementReference> _scrollContainers = new();
    private readonly Dictionary<Guid, string> _scrollClasses = new();

    protected override void OnInitialized()
    {
        var user = Auth.GetCurrentUser();
        if (user is null)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        _userId = user.Id;

        _columns =
        [
            new PrelineTable<Palette>.TableColumn<Palette>
            {
                Header = "Name",
                PropertyName = nameof(Palette.Name),
                Sortable = true,
                CssClass = "font-medium text-gray-800 dark:text-neutral-200",
                Template = palette => @<text>@palette.Name</text>
            },
            new PrelineTable<Palette>.TableColumn<Palette>
            {
                Header = "Blocks",
                PropertyName = "Blocks",
                Sortable = false,
                CssClass = "text-gray-500 dark:text-neutral-400",
                Template = palette => @<div @ref="_scrollContainers[palette.Id]"
                                            @onwheel="() => OnScroll(palette.Id)"
                                            @onwheel:preventDefault="true"
                                            class="flex flex-row gap-x-1 w-full overflow-x-auto relative
            max-w-full
            [&::-webkit-scrollbar]:h-2
            [&::-webkit-scrollbar-track]:bg-gray-100
            [&::-webkit-scrollbar-thumb]:bg-gray-300
            dark:[&::-webkit-scrollbar-track]:bg-neutral-700
            dark:[&::-webkit-scrollbar-thumb]:bg-neutral-500 @_scrollClasses.GetValueOrDefault(palette.Id, "")">
                                          @foreach (var block in palette.Blocks)
                                          {
                                              <div class="rounded-md border border-gray-600 p-0.5 dark:border-neutral-500 flex-shrink-0">
                                                  <img src="@block.ImageUrl"
                                                       alt="@block.MinecraftId"
                                                       title="@block.MinecraftId"
                                                       class="w-10 h-10 object-cover" />
                                              </div>
                                          }
                                      </div>

            }
        ];
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync(new PrelineTable<Palette>.PageChangedEventArgs(1, _pageSize, nameof(Palette.Name), true));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JS.InvokeAsync<IJSObjectReference>("import",
                "./Components/Pages/Palettes.razor.js");

            foreach (var paletteId in _scrollContainers.Keys)
            {
                await UpdateMask(paletteId);
            }
        }
    }

    private async Task LoadDataAsync(PrelineTable<Palette>.PageChangedEventArgs args)
    {
        if (_userId is null) return;

        _isLoading = true;
        StateHasChanged();

        await using var database = await DbContextFactory.CreateDbContextAsync();

        var query = database.Palettes
            .Where(p => p.UserId == _userId.Value)
            .Include(p => p.Blocks).AsQueryable();

        query = args.SortColumn switch
        {
            nameof(Palette.Name) => args.SortAscending
                ? query.OrderBy(p => p.Name)
                : query.OrderByDescending(p => p.Name) ,
            _ => query.OrderBy(p => p.Name)
        };

        _totalCount = await query.CountAsync();

        _palettes = await query
            .Skip((args.Page - 1) * args.PageSize)
            .Take(args.PageSize)
            .ToListAsync();

        _currentPage = args.Page;
        _pageSize = args.PageSize;
        _isLoading = false;

        foreach (var palette in _palettes)
        {
            _scrollClasses.TryAdd(palette.Id, "");
        }
    }

    private async Task OnScroll(Guid paletteId)
    {
        await UpdateMask(paletteId);
    }

    private async Task UpdateMask(Guid paletteId)
    {
        if (_module is null || !_scrollContainers.TryGetValue(paletteId, out var container)) return;

        try
        {
            var position = await _module.InvokeAsync<string>("getScrollPosition", container);
            
            _scrollClasses[paletteId] = position switch
            {
                "none" => "",
                "left" => "[mask-image:linear-gradient(to_right,transparent_0,black_30px,black_100%)]",
                "right" => "[mask-image:linear-gradient(to_right,black_30px,black_calc(100%-30px),transparent_100%)]",
                "both" => "[mask-image:linear-gradient(to_right,transparent_0,black_30px,black_calc(100%-30px),transparent_100%)]",
                _ => ""
            };

            StateHasChanged();
        }
        catch
        {
            // Ignore JS Interop errors
        }
    }

    private RenderFragment<Palette> ActionsTemplate => palette => @<text>
        <button @onclick="() => TogglePopover(palette.Id)" 
                @ref="@_buttonRefs[palette.Id]"
                type="button" 
                class="inline-flex items-center gap-x-1.5 text-sm font-medium text-gray-700 hover:text-gray-900 dark:text-neutral-300 dark:hover:text-white transition-colors duration-150">
            <span>Actions</span>
            <i class="ri-arrow-up-s-line text-gray-500 dark:text-neutral-400 transition-transform duration-150 @(_openPopovers.Contains(palette.Id) ? "rotate-90" : "")"></i>
        </button>
    </text>;

    private void CloseAllPopovers()
    {
        _openPopovers.Clear();
    }

    private async Task TogglePopover(Guid paletteId)
    {
        if (_openPopovers.Contains(paletteId))
        {
            _openPopovers.Remove(paletteId);
        }
        else
        {
            _openPopovers.Clear();
            _openPopovers.Add(paletteId);

            if (_buttonRefs.TryGetValue(paletteId, out var buttonRef))
            {
                try
                {
                    var rect = await JS.InvokeAsync<DomRect>("getBoundingClientRect", buttonRef);
                    double top = (int)(rect.Top + rect.Height + 10);
                    double left = (int)(rect.Left + rect.Width - 224);

                    _popoverPositions[paletteId] = $"top: {top}px; left: {left}px;";
                }
                catch
                {
                    _popoverPositions[paletteId] = "top: 0; left: 0;";
                }
            }
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private void EditPalette(Guid paletteId)
    {
        _openPopovers.Clear();
        NavigationManager.NavigateTo($"/palettes/{paletteId}");
    }

    private void ConfirmDeletePalette(Guid paletteId)
    {
        _openPopovers.Clear();
        _paletteToDelete = paletteId;
        _showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        _showDeleteConfirm = false;
        _paletteToDelete = Guid.Empty;
    }

    private async Task DeletePalette(Guid paletteId)
    {
        _showDeleteConfirm = false;

        var user = Auth.GetCurrentUser();
        if (user is null) return;
        
        await using var dbContext = await DbContextFactory.CreateDbContextAsync();
        var palette = await dbContext.Palettes.FindAsync(paletteId);
        
        if (palette is not null)
        {
            dbContext.Palettes.Remove(palette);
            await dbContext.SaveChangesAsync();
            
            await LoadDataAsync(new PrelineTable<Palette>.PageChangedEventArgs(
                _currentPage, 
                _pageSize, 
                nameof(Palette.Name), 
                true
            ));
        }
        
        _paletteToDelete = Guid.Empty;
    }

    private void NavigateToAddPalette()
    {
        NavigationManager.NavigateTo("/palettes/new");
    }
}