@page "/"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using SkiaSharp
@using WaxMapArt.Comparison
@using WaxMapArt.Dithering
@using WaxMapArt.Processing
@using WaxMapArt.Web.Components.Components
@using WaxMapArt.Web.Services
@using Palette = WaxMapArt.Web.Database.Palette
@implements IDisposable
@inject NavigationManager NavigationManager
@inject IDbContextFactory<DatabaseContext> DbContextFactory
@inject MapGeneratorService Generator

<PageTitle>WaxMapArt - Minecraft Map Art Generator</PageTitle>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Hero Section -->
    <div class="max-w-2xl mx-auto text-center mb-12 mt-8">
        <h1 class="block text-3xl font-bold text-gray-800 dark:text-white sm:text-4xl md:text-5xl">
            Create <span class="text-blue-600 dark:text-blue-500">Minecraft Map Art</span> from Any Image
        </h1>
        <p class="mt-3 text-lg text-gray-800 dark:text-neutral-400">
            Transform your favorite images into stunning map art in Minecraft using advanced color matching algorithms.
        </p>
        
        <AuthorizeView>
            <Authorized>
                <div class="mt-7 flex flex-col items-center justify-center gap-3 sm:flex-row">
                    <button type="button" @onclick='() => NavigationManager.NavigateTo("/map")'
                            class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none focus:outline-hidden focus:bg-blue-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Create Map Art
                    </button>
                    <button type="button" @onclick='() => NavigationManager.NavigateTo("/palettes")'
                            class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-gray-200 bg-white text-gray-800 hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:text-white dark:border-neutral-700 dark:hover:bg-neutral-800">
                        <i class="ri-palette-line"></i>
                        View Palettes
                    </button>
                </div>
            </Authorized>
            <NotAuthorized>
                <div class="mt-7 flex flex-col items-center justify-center gap-3 sm:flex-row">
                    <button type="button" @onclick='() => NavigationManager.NavigateTo("/signup")'
                            class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none focus:outline-hidden focus:bg-blue-700">
                        <i class="ri-user-add-line"></i>
                        Get Started
                    </button>
                    <button type="button" @onclick='() => NavigationManager.NavigateTo("/login")'
                            class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-gray-200 bg-white text-gray-800 hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:text-white dark:border-neutral-700 dark:hover:bg-neutral-800">
                        <i class="ri-login-circle-line"></i>
                        Log In
                    </button>
                </div>
            </NotAuthorized>
        </AuthorizeView>
    </div>

    <!-- Features Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 my-12">
        <!-- Feature 1 -->
        <div class="bg-white dark:bg-neutral-900 rounded-xl shadow-sm border border-gray-200 dark:border-neutral-700 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-center w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg mb-4">
                <i class="ri-image-add-line text-2xl text-blue-600 dark:text-blue-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">
                Easy Image Upload
            </h3>
            <p class="text-gray-600 dark:text-neutral-400">
                Simply upload any image and let our advanced algorithms convert it to map art. Support for multiple formats with up to 50MB file size.
            </p>
        </div>

        <!-- Feature 2 -->
        <div class="bg-white dark:bg-neutral-900 rounded-xl shadow-sm border border-gray-200 dark:border-neutral-700 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-center w-12 h-12 bg-green-100 dark:bg-green-900/20 rounded-lg mb-4">
                <i class="ri-settings-3-line text-2xl text-green-600 dark:text-green-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">
                Advanced Algorithms
            </h3>
            <p class="text-gray-600 dark:text-neutral-400">
                Choose from multiple color comparison methods (CIE76, CIE94, CIE2000, CMC, DeltaE ITP) and dithering algorithms for optimal results.
            </p>
        </div>

        <!-- Feature 3 -->
        <div class="bg-white dark:bg-neutral-900 rounded-xl shadow-sm border border-gray-200 dark:border-neutral-700 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-center w-12 h-12 bg-amber-100 dark:bg-amber-900/20 rounded-lg mb-4">
                <i class="ri-download-line text-2xl text-amber-600 dark:text-amber-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">
                Multiple Export Formats
            </h3>
            <p class="text-gray-600 dark:text-neutral-400">
                Export your map art as Vanilla NBT or Litematica schematics. Get complete material lists to help plan your builds.
            </p>
        </div>
    </div>

    <!-- How It Works -->
    <div class="bg-gradient-to-b from-blue-50 to-white dark:from-neutral-800 dark:to-neutral-900 rounded-2xl p-8 my-12 border border-gray-200 dark:border-neutral-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-8 text-center">
            How It Works
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-12 h-12 bg-blue-600 text-white rounded-full text-lg font-semibold mb-3">
                    1
                </div>
                <h3 class="font-semibold text-gray-800 dark:text-white mb-2">Upload</h3>
                <p class="text-sm text-gray-600 dark:text-neutral-400">Upload your image and select your palette</p>
            </div>
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-12 h-12 bg-blue-600 text-white rounded-full text-lg font-semibold mb-3">
                    2
                </div>
                <h3 class="font-semibold text-gray-800 dark:text-white mb-2">Customize</h3>
                <p class="text-sm text-gray-600 dark:text-neutral-400">Adjust settings, dithering, and processing options</p>
            </div>
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-12 h-12 bg-blue-600 text-white rounded-full text-lg font-semibold mb-3">
                    3
                </div>
                <h3 class="font-semibold text-gray-800 dark:text-white mb-2">Preview</h3>
                <p class="text-sm text-gray-600 dark:text-neutral-400">See how your map art will look before generating</p>
            </div>
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-12 h-12 bg-blue-600 text-white rounded-full text-lg font-semibold mb-3">
                    4
                </div>
                <h3 class="font-semibold text-gray-800 dark:text-white mb-2">Download</h3>
                <p class="text-sm text-gray-600 dark:text-neutral-400">Generate and download your NBT schematic file</p>
            </div>
        </div>
    </div>

    <!-- Call to Action -->
    <AuthorizeView>
        <NotAuthorized>
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-8 my-12 text-center text-white">
                <h2 class="text-2xl font-bold mb-4">
                    Ready to Create Map Art?
                </h2>
                <p class="mb-6 text-blue-100">
                    Sign up for free and start creating your Minecraft map art today.
                </p>
                <button type="button" @onclick='() => NavigationManager.NavigateTo("/signup")'
                        class="py-3 px-6 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border-2 border-white text-white hover:bg-white hover:text-blue-600 focus:outline-hidden transition-colors">
                    <i class="ri-user-add-line"></i>
                    Create Free Account
                </button>
            </div>
        </NotAuthorized>
    </AuthorizeView>

    <!-- Functional Preview Demo -->
    @if (_isDemoLoaded)
    {
        <div class="bg-white dark:bg-neutral-900 rounded-xl shadow-sm border border-gray-200 dark:border-neutral-700 p-6 my-12">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2">
                <i class="ri-eye-line text-amber-300"></i>
                Try It Now - Live Preview
            </h2>
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-red-800 dark:bg-red-900/20 dark:text-red-300 dark:border-red-900/40">
                    <div class="flex items-start gap-2">
                        <i class="ri-error-warning-line mt-0.5"></i>
                        <div>
                            <div class="font-semibold">Preview failed</div>
                            <div class="text-sm">@_errorMessage</div>
                        </div>
                    </div>
                </div>
            }
            <p class="text-gray-600 dark:text-neutral-400 mb-6">
                Experience our advanced preview system with a demo image. Adjust the settings below to see real-time changes.
            </p>

            @if (_originalImageUrl is not null)
            {
                        <!-- Settings Controls -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <PrelineSelect TValue="DitheringMode"
                                           @bind-SelectedValue="_demoForm.DitheringMode"
                                           Placeholder="Dithering Mode"
                                           SelectOptions="@(SelectOption.FromEnum<DitheringMode>())" />
                            <PrelineSelect TValue="ComparisonMode"
                                           @bind-SelectedValue="_demoForm.ComparisonMode"
                                           Placeholder="Comparison Mode"
                                           SelectOptions="@(SelectOption.FromEnum<ComparisonMode>())" />
                            <PrelineSelect TValue="StaircaseMode"
                                           @bind-SelectedValue="_demoForm.StaircaseMode"
                                           Placeholder="Generator Type"
                                           SelectOptions="@(SelectOption.FromEnum<StaircaseMode>())" />
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-neutral-300 mb-2">Brightness</label>
                                <PrelineInputNumber TValue="float"
                                                    Value="_demoForm.Brightness"
                                                    ValueChanged="@(value => _demoForm.Brightness = value)"
                                                    Variant="InputNumberVariant.Horizontal"
                                                    DecimalPlaces="2"
                                                    Min="0.0f" Max="2.0f" Step="0.05f" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-neutral-300 mb-2">Contrast</label>
                                <PrelineInputNumber TValue="float"
                                                    Value="_demoForm.Contrast"
                                                    ValueChanged="@(value => _demoForm.Contrast = value)"
                                                    Variant="InputNumberVariant.Horizontal"
                                                    DecimalPlaces="2"
                                                    Min="0.0f" Max="2.0f" Step="0.05f" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-neutral-300 mb-2">Saturation</label>
                                <PrelineInputNumber TValue="float"
                                                    Value="_demoForm.Saturation"
                                                    ValueChanged="@(value => _demoForm.Saturation = value)"
                                                    Variant="InputNumberVariant.Horizontal"
                                                    DecimalPlaces="2"
                                                    Min="0.0f" Max="2.0f" Step="0.05f" />
                            </div>
                        </div>

                        <!-- Advanced Options (conditional) -->
                        @if (_demoForm.DitheringMode is DitheringMode.Atkinson or DitheringMode.FloydSteinberg or DitheringMode.JarvisJudiceNinke)
                        {
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-neutral-300 mb-2">Dithering Strength</label>
                                    <PrelineInputNumber TValue="float"
                                                        Value="_demoForm.ErrorDiffusionStrength"
                                                        ValueChanged="@(value => _demoForm.ErrorDiffusionStrength = value)"
                                                        Variant="InputNumberVariant.Horizontal"
                                                        DecimalPlaces="2"
                                                        Min="0" Max="2" Step="0.05f" />
                                </div>
                            </div>
                        }

                        @if (_demoForm.StaircaseMode == StaircaseMode.AdaptiveStaircase)
                        {
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-neutral-300 mb-2">Adaptive Threshold</label>
                                    <PrelineInputNumber TValue="double"
                                                        Value="_demoForm.AdaptiveStaircaseThreshold"
                                                        ValueChanged="@(value => _demoForm.AdaptiveStaircaseThreshold = value)"
                                                        Variant="InputNumberVariant.Horizontal"
                                                        DecimalPlaces="2"
                                                        Min="0.0d" Max="50.0d" Step="0.05d" />
                                </div>
                            </div>
                        }

                        <!-- Preview Images -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Original -->
                            <div class="space-y-3">
                                <div class="relative aspect-square overflow-hidden rounded-lg border-2 border-gray-200 dark:border-neutral-700">
                                    <img src="@_originalImageUrl" class="w-full h-full object-cover" alt="Original"/>
                                    <PrelineBadge Variant="PrelineBadgeVariant.Soft" Color="gray-800" BackgroundColor="gray-100" 
                                                  Class="absolute top-4 right-4">Original</PrelineBadge>
                                </div>
                            </div>

                            <!-- Processed -->
                            @if (_preProcessedImageUrl is not null)
                            {
                                <div class="space-y-3">
                                    <div class="relative aspect-square overflow-hidden rounded-lg border-2 border-blue-300 dark:border-blue-700">
                                        <img src="@_preProcessedImageUrl" class="w-full h-full object-cover" alt="Pre-processed"/>
                                        <PrelineBadge Variant="PrelineBadgeVariant.Soft" Color="blue-600" BackgroundColor="blue-100" 
                                                      Class="absolute top-4 right-4 dark:bg-blue-800/30 dark:text-blue-400">Pre-processed</PrelineBadge>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="space-y-3">
                                    <div class="relative aspect-square flex items-center justify-center bg-blue-50 dark:bg-blue-900/10 rounded-lg border-2 border-blue-300 dark:border-blue-700">
                                        <div class="text-center text-blue-600 dark:text-blue-400">
                                            <svg class="animate-spin h-8 w-8 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <p class="text-sm">Processing...</p>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Generated -->
                            @if (_generatedImageUrl is not null)
                            {
                                <div class="space-y-3">
                                    <div class="relative aspect-square overflow-hidden rounded-lg border-2 border-amber-300 dark:border-amber-700">
                                        <img src="@_generatedImageUrl" class="w-full h-full object-cover" alt="Generated"/>
                                        <PrelineBadge Variant="PrelineBadgeVariant.Soft" Color="amber-800" BackgroundColor="amber-100" 
                                                      Class="absolute top-4 right-4 dark:bg-amber-800/30 dark:text-amber-400">Generated</PrelineBadge>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="space-y-3">
                                    <div class="relative aspect-square flex items-center justify-center bg-amber-50 dark:bg-amber-900/10 rounded-lg border-2 border-amber-300 dark:border-amber-700">
                                        <div class="text-center text-amber-600 dark:text-amber-400">
                                            <i class="ri-image-add-line text-4xl mb-2"></i>
                                            <p class="text-sm">Ready to generate</p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="mt-6 text-center">
                            <AuthorizeView>
                                <Authorized>
                                    <button type="button" @onclick='() => NavigationManager.NavigateTo("/map")'
                                            class="py-3 px-6 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 focus:outline-hidden focus:bg-blue-700">
                                        <i class="ri-flashlight-line"></i>
                                        Create Your Own Map Art
                                    </button>
                                </Authorized>
                                <NotAuthorized>
                                    <button type="button" @onclick='() => NavigationManager.NavigateTo("/signup")'
                                            class="py-3 px-6 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 focus:outline-hidden focus:bg-blue-700">
                                        <i class="ri-user-add-line"></i>
                                        Sign Up to Create Your Own
                                    </button>
                                </NotAuthorized>
                            </AuthorizeView>
                        </div>
                    }
                </div>
    }

    <!-- Additional Features Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 my-12">
        <div class="bg-white dark:bg-neutral-900 rounded-xl shadow-sm border border-gray-200 dark:border-neutral-700 p-6">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3 flex items-center gap-2">
                <i class="ri-palette-line text-purple-500"></i>
                Custom Palettes
            </h3>
            <p class="text-gray-600 dark:text-neutral-400 mb-4">
                Create and manage your own palettes with specific block collections tailored to your build style.
            </p>
            <AuthorizeView>
                <Authorized>
                    <button type="button" @onclick='() => NavigationManager.NavigateTo("/palettes")'
                            class="text-sm text-purple-600 dark:text-purple-400 hover:underline font-medium">
                        Manage Palettes →
                    </button>
                </Authorized>
            </AuthorizeView>
        </div>

        <div class="bg-white dark:bg-neutral-900 rounded-xl shadow-sm border border-gray-200 dark:border-neutral-700 p-6">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3 flex items-center gap-2">
                <i class="ri-github-line text-gray-800 dark:text-white"></i>
                Open Source on GitHub
            </h3>
            <p class="text-gray-600 dark:text-neutral-400 mb-4">
                Explore the source code, track issues, and contribute to WaxMapArt.
            </p>
            <a href="https://github.com/lllggghhhaaa/WaxMapArt" target="_blank" rel="noopener noreferrer"
               class="text-sm text-blue-600 dark:text-blue-400 hover:underline font-medium">
                View Repository →
            </a>
        </div>
    </div>
</div>

@code {
    private DatabaseContext? _database;
    private SKBitmap? _inputImage;
    private Palette? _defaultPalette;

    private string? _originalImageUrl;
    private string? _preProcessedImageUrl;
    private string? _generatedImageUrl;
    private bool _isDemoLoaded;
    private string? _errorMessage;
    private CancellationTokenSource? _debounceCts;

    private readonly DemoFormModel _demoForm = new();

    protected override void OnInitialized()
    {
        _demoForm.SetPreProcessingChangeCallback(OnPreProcessingChange);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            await LoadDemoImage();
            _isDemoLoaded = _originalImageUrl is not null;
            StateHasChanged();

            _database = await DbContextFactory.CreateDbContextAsync();

            _defaultPalette = await _database.Palettes
                .AsNoTracking()
                .Include(p => p.Blocks)
                .Include(p => p.PlaceholderBlock)
                .OrderBy(p => p.Name)
                .Take(1)
                .FirstOrDefaultAsync();

            if (_defaultPalette is null)
            {
                _errorMessage = "No palette found. Create a palette to enable the demo preview.";
                StateHasChanged();
                return;
            }

            if (_defaultPalette.PlaceholderBlock is null)
            {
                _errorMessage = "Default palette is missing a placeholder block. Please update the palette.";
                StateHasChanged();
                return;
            }

            _demoForm.SelectedPalette = _defaultPalette;
            await GeneratePreview();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            StateHasChanged();
        }
    }

    private async Task LoadDemoImage()
    {
        try
        {
            using var httpClient = new HttpClient { Timeout = TimeSpan.FromSeconds(3) };
            var imageBytes = await httpClient.GetByteArrayAsync("https://picsum.photos/256/256");
            
            _inputImage = SKBitmap.Decode(imageBytes);
            
            if (_inputImage is not null)
            {
                using var image = SKImage.FromBitmap(_inputImage);
                using var imageData = image.Encode(SKEncodedImageFormat.Png, 100);
                _originalImageUrl = ConvertStreamToBase64Url(imageData.ToArray());
                
                using var resized = new SKBitmap(256, 256);
                _inputImage.ScalePixels(resized, new SKSamplingOptions(SKFilterMode.Linear, SKMipmapMode.Nearest));
                
                _inputImage.Dispose();
                _inputImage = resized.Copy();
            }
        }
        catch (TaskCanceledException)
        {
            _errorMessage = "Loading demo image timed out. Please retry.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading demo image: {ex.Message}";
        }
    }

    private async Task OnPreProcessingChange()
    {
        if (_inputImage is null) return;
        _debounceCts?.Cancel();
        _debounceCts?.Dispose();
        _debounceCts = new CancellationTokenSource();
        var token = _debounceCts.Token;

        try
        {
            await Task.Delay(300, token);
            if (token.IsCancellationRequested) return;
            await GeneratePreview();
            if (!token.IsCancellationRequested)
            {
                StateHasChanged();
            }
        }
        catch (TaskCanceledException)
        {
            // ignored - debounced
        }
    }

    private async Task GeneratePreview()
    {
        _errorMessage = null;
        if (_inputImage is null)
        {
            _errorMessage = "Demo image not loaded yet.";
            return;
        }
        if (_demoForm.SelectedPalette is null)
        {
            _errorMessage = "No palette available to generate preview.";
            return;
        }

        var ditheringOptions = _demoForm.DitheringMode is DitheringMode.Atkinson or DitheringMode.FloydSteinberg or DitheringMode.JarvisJudiceNinke
            ? new DitheringOptions
            {
                ErrorDiffusionStrength = _demoForm.ErrorDiffusionStrength,
                SerpentineScanning = false
            }
            : null;

        var request = new MapGenerationRequest
        {
            InputImage = _inputImage,
            Palette = _demoForm.SelectedPalette,
            WidthMultiplier = 2,
            HeightMultiplier = 2,
            ResizeMethod = ResizeMethod.Crop,
            CropOffsetX = 0,
            CropOffsetY = 0,
            PadColor = "#FFFFFF",
            Saturation = _demoForm.Saturation,
            Brightness = _demoForm.Brightness,
            Contrast = _demoForm.Contrast,
            DitheringMode = _demoForm.DitheringMode,
            DitheringOptions = ditheringOptions,
            ComparisonMode = _demoForm.ComparisonMode,
            StaircaseMode = _demoForm.StaircaseMode,
            AdaptiveStaircaseThreshold = _demoForm.AdaptiveStaircaseThreshold,
            ShouldGenerateStructure = false
        };

        try
        {
            var result = await Task.Run(() => Generator.Generate(request));
            if (result is null)
            {
                _errorMessage = "Preview generation returned no result.";
                _preProcessedImageUrl = null;
                _generatedImageUrl = null;
                return;
            }
            _preProcessedImageUrl = result.ProcessedImage is not null ? ConvertStreamToBase64Url(result.ProcessedImage) : null;
            _generatedImageUrl = result.GeneratedImage is not null ? ConvertStreamToBase64Url(result.GeneratedImage) : null;
            if (_preProcessedImageUrl is null && _generatedImageUrl is null)
            {
                _errorMessage = "Preview images are empty.";
            }
        }
        catch (Exception ex)
        {
            _preProcessedImageUrl = null;
            _generatedImageUrl = null;
            _errorMessage = ex.Message;
        }
    }

    private static string ConvertStreamToBase64Url(byte[] data, string contentType = "image/png")
        => $"data:{contentType};base64,{Convert.ToBase64String(data)}";

    public void Dispose()
    {
        _database?.Dispose();
        _inputImage?.Dispose();
        _debounceCts?.Dispose();
    }

    private class DemoFormModel
    {
        private float _saturation = 1.0f;
        private float _brightness = 1.0f;
        private float _contrast = 1.0f;
        private float _errorDiffusionStrength = 1.0f;
        private double _adaptiveStaircaseThreshold = 10.0d;
        private DitheringMode _ditheringMode = DitheringMode.None;
        private ComparisonMode _comparisonMode = ComparisonMode.Cie76;
        private StaircaseMode _staircaseMode = StaircaseMode.Flat;
        private Func<Task>? _preProcessingChangeCallback;

        public Palette? SelectedPalette { get; set; }

        public DitheringMode DitheringMode
        {
            get => _ditheringMode;
            set
            {
                if (_ditheringMode == value) return;
                _ditheringMode = value;
                _preProcessingChangeCallback?.Invoke();
            }
        }

        public ComparisonMode ComparisonMode
        {
            get => _comparisonMode;
            set
            {
                if (_comparisonMode == value) return;
                _comparisonMode = value;
                _preProcessingChangeCallback?.Invoke();
            }
        }

        public StaircaseMode StaircaseMode
        {
            get => _staircaseMode;
            set
            {
                if (_staircaseMode == value) return;
                _staircaseMode = value;
                _preProcessingChangeCallback?.Invoke();
            }
        }

        public float Saturation
        {
            get => _saturation;
            set
            {
                if (Math.Abs(_saturation - value) < float.Epsilon) return;
                _saturation = value;
                _preProcessingChangeCallback?.Invoke();
            }
        }

        public float Brightness
        {
            get => _brightness;
            set
            {
                if (Math.Abs(_brightness - value) < float.Epsilon) return;
                _brightness = value;
                _preProcessingChangeCallback?.Invoke();
            }
        }

        public float Contrast
        {
            get => _contrast;
            set
            {
                if (Math.Abs(_contrast - value) < float.Epsilon) return;
                _contrast = value;
                _preProcessingChangeCallback?.Invoke();
            }
        }

        public float ErrorDiffusionStrength
        {
            get => _errorDiffusionStrength;
            set
            {
                if (Math.Abs(_errorDiffusionStrength - value) < float.Epsilon) return;
                _errorDiffusionStrength = value;
                _preProcessingChangeCallback?.Invoke();
            }
        }

        public double AdaptiveStaircaseThreshold
        {
            get => _adaptiveStaircaseThreshold;
            set
            {
                if (Math.Abs(_adaptiveStaircaseThreshold - value) < double.Epsilon) return;
                _adaptiveStaircaseThreshold = value;
                _preProcessingChangeCallback?.Invoke();
            }
        }

        public void SetPreProcessingChangeCallback(Func<Task> callback)
        {
            _preProcessingChangeCallback = callback;
        }
    }
}

 